"use strict";(()=>{var e={};e.id=231,e.ids=[231],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},524:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1808:e=>{e.exports=require("net")},6005:e=>{e.exports=require("node:crypto")},1041:e=>{e.exports=require("node:url")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},7282:e=>{e.exports=require("process")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},3913:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>U,patchFetch:()=>j,requestAsyncStorage:()=>S,routeModule:()=>R,serverHooks:()=>q,staticGenerationAsyncStorage:()=>_});var n={};t.r(n),t.d(n,{OPTIONS:()=>x,POST:()=>P});var o=t(5820),a=t(3944),s=t(765),i=t(643),d=t(2458),u=t(7568),c=t(3775),p=t(6005),m=t.n(p);let l={randomUUID:m().randomUUID},h=new Uint8Array(256),g=h.length,f=[];for(let e=0;e<256;++e)f.push((e+256).toString(16).slice(1));let y=function(e,r,t){if(l.randomUUID&&!r&&!e)return l.randomUUID();let n=(e=e||{}).random||(e.rng||function(){return g>h.length-16&&(m().randomFillSync(h),g=0),h.slice(g,g+=16)})();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,r){t=t||0;for(let e=0;e<16;++e)r[t+e]=n[e];return r}return function(e,r=0){return(f[e[r+0]]+f[e[r+1]]+f[e[r+2]]+f[e[r+3]]+"-"+f[e[r+4]]+f[e[r+5]]+"-"+f[e[r+6]]+f[e[r+7]]+"-"+f[e[r+8]]+f[e[r+9]]+"-"+f[e[r+10]]+f[e[r+11]]+f[e[r+12]]+f[e[r+13]]+f[e[r+14]]+f[e[r+15]]).toLowerCase()}(n)};var v=t(8895),w=t(7961),b=t(279),k=t(2858);let x=()=>Response.json(null,{headers:i.jS}),P=async(e,{params:r})=>{try{let t,n;let o=new URL(e.url),a=new URLSearchParams(o.search),s=a.get("name"),p=a.get("email"),m=a.get("address"),l=a.get("zipcode"),h=a.get("city"),g=a.get("amount"),f=a.get("state");if(!s||!p||!m||!l||!h||!g||!f)return Response.json({message:"Incomplete data"},{headers:i.jS});let x=await b.Z.product.findUnique({where:{id:r.productid},include:{seller:!0}});if(!x)return Response.json({message:"Product not available"},{headers:i.jS});let P=await e.json();try{t=new u.PublicKey(P.account)}catch(e){return Response.json({message:'Invalid "account" provided'},{headers:i.jS})}let R=(0,v.B)(),S=new u.Transaction,_=y(),q=(0,w.$)(_);try{let e=u.PublicKey.findProgramAddressSync([Buffer.from("order"),t.toBuffer(),Buffer.from(q)],k.N.programId)[0],r=u.PublicKey.findProgramAddressSync([Buffer.from("orderVault"),e.toBuffer()],k.N.programId)[0];n=await k.N.methods.createOrder(q,new c.BN(Number(x.price)*u.LAMPORTS_PER_SOL)).accountsPartial({seller:new u.PublicKey(x.seller.walletAddress),user:t,order:e,orderVault:r}).instruction()}catch(e){return console.error("Error creating anchor instruction:",e),Response.json({message:"Error creating order"},{headers:i.jS})}if(!n)return Response.json({message:"Failed to create transaction instruction"},{headers:i.jS});S.add(n),S.feePayer=t,S.recentBlockhash=(await R.getLatestBlockhash()).blockhash;let U=`/api/actions/purchasedone?name=${encodeURIComponent(s)}&email=${encodeURIComponent(p)}&address=${encodeURIComponent(m)}&zipcode=${encodeURIComponent(l)}&city=${encodeURIComponent(h)}&amount=${encodeURIComponent(g)}&state=${encodeURIComponent(f)}&productid=${encodeURIComponent(r.productid)}&uuid=${_}`,j=await (0,d.p)({fields:{transaction:S,links:{next:{type:"post",href:U}}}});return Response.json(j,{headers:i.jS})}catch(e){return console.error("Error processing purchase:",e),Response.json({message:"Error processing request"},{headers:i.jS})}},R=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/actions/[username]/product/[productid]/purchase/route",pathname:"/api/actions/[username]/product/[productid]/purchase",filename:"route",bundlePath:"app/api/actions/[username]/product/[productid]/purchase/route"},resolvedPagePath:"/workspaces/blink-e-commerce/src/app/api/actions/[username]/product/[productid]/purchase/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:S,staticGenerationAsyncStorage:_,serverHooks:q}=R,U="/api/actions/[username]/product/[productid]/purchase/route";function j(){return(0,s.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:_})}},2858:(e,r,t)=>{t.d(r,{N:()=>u,b:()=>i});var n=t(3775),o=t(7568);let a=JSON.parse('{"address":"EEFaeBjspJjSk1zMW6noT99B9YibP1Y3EXdm5ekuXcQ2","metadata":{"name":"e-commerce_escrow","version":"0.1.0","spec":"0.1.0","description":"Created with Anchor"},"instructions":[{"name":"cancel_order","discriminator":[95,129,237,240,8,49,223,132],"accounts":[{"name":"user","writable":true,"signer":true},{"name":"order","writable":true,"pda":{"seeds":[{"kind":"const","value":[111,114,100,101,114]},{"kind":"account","path":"user"},{"kind":"account","path":"order.order_id","account":"Order"}]}},{"name":"order_vault","writable":true,"pda":{"seeds":[{"kind":"const","value":[111,114,100,101,114,86,97,117,108,116]},{"kind":"account","path":"order"}]}},{"name":"system_program","address":"11111111111111111111111111111111"}],"args":[{"name":"order_id","type":"string"}]},{"name":"create_order","discriminator":[141,54,37,207,237,210,250,215],"accounts":[{"name":"user","writable":true,"signer":true},{"name":"order","writable":true,"pda":{"seeds":[{"kind":"const","value":[111,114,100,101,114]},{"kind":"account","path":"user"},{"kind":"arg","path":"order_id"}]}},{"name":"order_vault","writable":true,"pda":{"seeds":[{"kind":"const","value":[111,114,100,101,114,86,97,117,108,116]},{"kind":"account","path":"order"}]}},{"name":"seller"},{"name":"system_program","address":"11111111111111111111111111111111"}],"args":[{"name":"order_id","type":"string"},{"name":"amount","type":"u64"}]},{"name":"finalize_order","discriminator":[198,89,84,237,43,9,99,55],"accounts":[{"name":"user","writable":true,"signer":true},{"name":"reciever"},{"name":"order","writable":true,"pda":{"seeds":[{"kind":"const","value":[111,114,100,101,114]},{"kind":"account","path":"reciever"},{"kind":"account","path":"order.order_id","account":"Order"}]}},{"name":"order_vault","writable":true,"pda":{"seeds":[{"kind":"const","value":[111,114,100,101,114,86,97,117,108,116]},{"kind":"account","path":"order"}]}},{"name":"system_program","address":"11111111111111111111111111111111"}],"args":[{"name":"order_id","type":"string"}]}],"accounts":[{"name":"Order","discriminator":[134,173,223,185,77,86,28,51]}],"errors":[{"code":6000,"name":"SellerNotAuthorized","msg":"Seller not authorized"},{"code":6001,"name":"RecieverNotAuthorized","msg":"Reciever not authorized"},{"code":6002,"name":"OrderIdMismatch","msg":"Order id mismatch"}],"types":[{"name":"Order","type":{"kind":"struct","fields":[{"name":"reciever","type":"pubkey"},{"name":"amount","type":"u64"},{"name":"order_id","docs":["TBD BASED ON db_id"],"type":"string"},{"name":"seller","type":"pubkey"},{"name":"bump","type":"u8"},{"name":"vault_bump","type":"u8"}]}}],"constants":[{"name":"SEED","type":"string","value":"\\"anchor\\""}]}');var s=t(8895);let i=new o.PublicKey("EEFaeBjspJjSk1zMW6noT99B9YibP1Y3EXdm5ekuXcQ2"),d=(0,s.B)(),u=new n.$r(a,{connection:d})},279:(e,r,t)=>{t.d(r,{Z:()=>o});var n=t(3524);let o=global.prismaGlobal??new n.PrismaClient},8895:(e,r,t)=>{t.d(r,{B:()=>o});var n=t(7568);let o=()=>new n.Connection(process.env.NEXT_PUBLIC_RPC_END_POINT||(0,n.clusterApiUrl)("devnet"),"confirmed")},7961:(e,r,t)=>{t.d(r,{$:()=>n});function n(e){if("string"!=typeof e||36!==e.length)throw Error("Input must be a valid UUID string");return function(e){if("string"!=typeof e)throw Error("Input must be a string");return e.slice(0,10)}(e)}}};var r=require("../../../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[544,744,458,775],()=>t(3913));module.exports=n})();